SUBDIRS= src kiwix desktop static etc
EXTRA_DIST= \
	kiwix \
	desktop \
	static \
	etc \
	CHANGELOG \
	COMPILE

CLEANFILES= \
	kiwix/components/zimAccessor.so \
	kiwix/components/zimAccessor.dylib \
	kiwix/components/zimAccessor.xpt \
	kiwix/components/xapianAccessor.so \
	kiwix/components/xapianAccessor.dylib \
	kiwix/components/xapianAccessor.xpt \
	kiwix/components/zimXapianIndexer.so \
	kiwix/components/zimXapianIndexer.dylib \
	kiwix/components/zimXapianIndexer.xpt \
	kiwix/components/cluceneAccessor.so \
	kiwix/components/cluceneAccessor.xpt \
	kiwix/components/zimCluceneIndexer.so \
	kiwix/components/zimCluceneIndexer.xpt \
	kiwix*.deb \
	kiwix*.tar.gz \
	kiwix*.changes \
	kiwix*.dsc

UPDATE_MIME = \
	if which update-mime-database>/dev/null 2>&1; then \
		update-mime-database $(DESTDIR)$(prefix)/share/mime; \
	fi

UPDATE_DESKTOP = \
	if which update-desktop-database>/dev/null 2>&1 ; then \
		update-desktop-database; \
	fi

if IS_OSX
bscript := ""
else
bscript := $(shell readlink -f ./build-kiwix-release.sh)
endif

if IS_OSX
all-local: kiwix/components/xapianAccessor.dylib \
	kiwix/components/xapianAccessor.xpt \
	kiwix/components/zimAccessor.dylib \
	kiwix/components/zimAccessor.xpt \
	kiwix/components/zimXapianIndexer.dylib \
	kiwix/components/zimXapianIndexer.xpt \
	kiwix/components/zimXapianIndexer.dylib \
	kiwix/components/cluceneAccessor.dylib \
	kiwix/components/cluceneAccessor.xpt \
	kiwix/components/zimCluceneIndexer.dylib \
	kiwix/components/zimCluceneIndexer.xpt \
	kiwix/components/contentManager.xpt \
	kiwix/components/contentManager.dylib
else
all-local: kiwix/components/xapianAccessor.so \
	kiwix/components/xapianAccessor.xpt \
	kiwix/components/zimAccessor.so \
	kiwix/components/zimAccessor.xpt \
	kiwix/components/zimXapianIndexer.so \
	kiwix/components/zimXapianIndexer.xpt \
	kiwix/components/cluceneAccessor.so \
	kiwix/components/cluceneAccessor.xpt \
	kiwix/components/zimCluceneIndexer.so \
	kiwix/components/zimCluceneIndexer.xpt \
	kiwix/components/contentManager.so \
	kiwix/components/contentManager.xpt
endif

dist-hook:
	rm -rf `find $(distdir) -name "*.svn" -o -name "*.dat" -o -name "*~" -o -name "*#"`

kiwix/components/zimAccessor.so: 
	ln -f -s ../../src/components/zimAccessor/.libs/libZimAccessor.so ./kiwix/components/zimAccessor.so

kiwix/components/zimAccessor.xpt: 
	ln -f -s ../../src/components/zimAccessor/zimAccessor.xpt ./kiwix/components/zimAccessor.xpt

kiwix/components/xapianAccessor.so: 
	ln -f -s ../../src/components/xapianAccessor/.libs/libXapianAccessor.so ./kiwix/components/xapianAccessor.so

kiwix/components/xapianAccessor.xpt:
	ln -f -s ../../src/components/xapianAccessor/xapianAccessor.xpt ./kiwix/components/xapianAccessor.xpt

kiwix/components/zimXapianIndexer.so:
	ln -f -s ../../src/components/zimXapianIndexer/.libs/libZimXapianIndexer.so  ./kiwix/components/zimXapianIndexer.so

kiwix/components/zimXapianIndexer.xpt: 
	ln -f -s ../../src/components/zimXapianIndexer/zimXapianIndexer.xpt ./kiwix/components/zimXapianIndexer.xpt

kiwix/components/cluceneAccessor.so: 
	ln -f -s ../../src/components/cluceneAccessor/.libs/libCluceneAccessor.so ./kiwix/components/cluceneAccessor.so

kiwix/components/cluceneAccessor.xpt:
	ln -f -s ../../src/components/cluceneAccessor/cluceneAccessor.xpt ./kiwix/components/cluceneAccessor.xpt

kiwix/components/zimCluceneIndexer.so:
	ln -f -s ../../src/components/zimCluceneIndexer/.libs/libZimCluceneIndexer.so  ./kiwix/components/zimCluceneIndexer.so

kiwix/components/zimCluceneIndexer.xpt: 
	ln -f -s ../../src/components/zimCluceneIndexer/zimCluceneIndexer.xpt ./kiwix/components/zimCluceneIndexer.xpt

kiwix/components/contentManager.so: 
	ln -f -s ../../src/components/contentManager/.libs/libContentManager.so ./kiwix/components/contentManager.so

kiwix/components/contentManager.xpt:
	ln -f -s ../../src/components/contentManager/contentManager.xpt ./kiwix/components/contentManager.xpt

kiwix/components/zimAccessor.dylib: 
	ln -f -s ../../src/components/zimAccessor/.libs/libZimAccessor.dylib ./kiwix/components/zimAccessor.dylib

kiwix/components/xapianAccessor.dylib: 
	ln -f -s ../../src/components/xapianAccessor/.libs/libXapianAccessor.dylib ./kiwix/components/xapianAccessor.dylib

kiwix/components/zimXapianIndexer.dylib:
	ln -f -s ../../src/components/zimXapianIndexer/.libs/libZimXapianIndexer.dylib  ./kiwix/components/zimXapianIndexer.dylib

kiwix/components/contentManager.dylib: 
	ln -f -s ../../src/components/contentManager/.libs/libContentManager.dylib ./kiwix/components/contentManager.dylib

kiwix/components/cluceneAccessor.dylib: 
	ln -f -s ../../src/components/cluceneAccessor/.libs/libCluceneAccessor.dylib ./kiwix/components/cluceneAccessor.dylib

kiwix/components/zimCluceneIndexer.dylib:
	ln -f -s ../../src/components/zimCluceneIndexer/.libs/libZimCluceneIndexer.dylib  ./kiwix/components/zimCluceneIndexer.dylib

bindist: 
	cd /tmp && ${bscript} --static $(VERSION)

deb: dist
	if [ `whereis dpkg-buildpackage | cut -f2 -d" "` == "dpkg-buildpackage:" ] ; then echo "You have to install dpkg-buildpackage" ; exit 1 ; fi
	tar -xvzf $(PACKAGE)-$(VERSION).tar.gz
	cp -r debian $(PACKAGE)-$(VERSION)/
	rm -rf `find $(PACKAGE)-$(VERSION)/debian/ -name "*.svn" -o -name "*.dat" -o -name "*~" -o -name "*#"`
	cd $(PACKAGE)-$(VERSION) ; dpkg-buildpackage -rfakeroot

rpm: dist
	$(MKDIR_P) ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
	echo "%_topdir $${HOME}/rpmbuild" > ~/.rpmmacros
	cp -f $(PACKAGE)-$(VERSION).tar.gz ~/rpmbuild/SOURCES/
	rpmbuild -ba fedora/kiwix.spec
	cp ~/rpmbuild/RPMS/*/*.rpm .

xo: 
	echo Not ready yet

# alter preferences: default skin is sugar. probably content location too.

static: dist
	rm -rf $(STATIC_TMP)
	mkdir -p $(STATIC_TMP)

	cp -Lr ./kiwix $(STATIC_TMP)/
	rm -rf `find $(STATIC_TMP)/kiwix -type d -name .svn`
	find $(STATIC_TMP)/kiwix -name '*.inised' -exec rm -rf {} \;
	find $(STATIC_TMP)/kiwix -name 'Makefile' -delete
	find $(STATIC_TMP)/kiwix -name 'Makefile.in' -delete
	find $(STATIC_TMP)/kiwix -name 'Makefile.am*' -delete

	mv $(STATIC_TMP)/kiwix/chrome/content/main/js/logger_rlz.js $(STATIC_TMP)/kiwix/chrome/content/main/js/logger.js

	cp -r $(XULRUNNER_RUNTIME_PATH) $(STATIC_TMP)/kiwix/xulrunner
	chmod +x $(STATIC_TMP)/kiwix/xulrunner/xulrunner $(STATIC_TMP)/kiwix/xulrunner/xulrunner-bin
	cp -v $(STATIC_TMP)/kiwix/xulrunner/libplc4.so $(STATIC_TMP)/kiwix/xulrunner/libplc4.so.0d
	cp -v $(STATIC_TMP)/kiwix/xulrunner/libnspr4.so $(STATIC_TMP)/kiwix/xulrunner/libnspr4.so.0d
	cp -v $(STATIC_TMP)/kiwix/xulrunner/libplds4.so $(STATIC_TMP)/kiwix/xulrunner/libplds4.so.0d

	cp -Lv $(STATIC_LIBS) $(STATIC_TMP)/kiwix/xulrunner/

	ln -s ./liblzma.so $(STATIC_TMP)/kiwix/xulrunner/liblzma.so.5
	ln -s ./libclucene.so $(STATIC_TMP)/kiwix/xulrunner/libclucene.so.0

	strip `find $(STATIC_TMP)/kiwix -executable -type f | grep -v ".sh" | grep -v ".py" | grep -v sugar` || true

	cp -v src/launcher/kiwix-launcher $(STATIC_TMP)/kiwix/kiwix

	mkdir -p $(STATIC_TMP)/kiwix/bin
	cp -v $(COMPILED_ARIA2_FILES) $(STATIC_TMP)/kiwix/bin/aria2c
	cp -v $(COMPILED_XAPIAN_COMPACT) $(STATIC_TMP)/kiwix/bin/xapian-compact

	rm $(STATIC_TMP)/kiwix/*.bat
	rm $(STATIC_TMP)/kiwix/xulrunner/libmicrohttpd.so

	tar -C $(STATIC_TMP) -cvjf $(PACKAGE)-$(VERSION)-static-$(ARCH).tar.bz2 kiwix

# Mac OSX rule
# requires install of XR
distmac: dist

	rm -rf kiwix_dmg
	rm -rf Kiwix.app
	$(MKDIR_P) Kiwix.app
	$(MKDIR_P) Kiwix.app/Contents
	$(MKDIR_P) Kiwix.app/Contents/Frameworks
	$(MKDIR_P) Kiwix.app/Contents/MacOS
	$(MKDIR_P) Kiwix.app/Contents/Resources
	
	cp -LR ./kiwix/ Kiwix.app/Contents/Resources/
	rm -rf `find Kiwix.app/Contents/Resources -type d -name .svn`
	find Kiwix.app/Contents/Resources -name '*.inised' -exec rm -rf {} \;
	find Kiwix.app/Contents/Resources -name 'Makefile' -delete
	find Kiwix.app/Contents/Resources -name 'Makefile.in' -delete
	find Kiwix.app/Contents/Resources -name 'Makefile.am*' -delete

	find Kiwix.app/Contents/Resources/components/ -type l -delete
	cp -v ./kiwix/components/zimAccessor.xpt Kiwix.app/Contents/Resources/components/zimAccessor.xpt
	cp -v ./kiwix/components/zimAccessor.dylib Kiwix.app/Contents/Resources/components/zimAccessor.dylib
	cp -v ./kiwix/components/xapianAccessor.xpt Kiwix.app/Contents/Resources/components/xapianAccessor.xpt
	cp -v ./kiwix/components/xapianAccessor.dylib Kiwix.app/Contents/Resources/components/xapianAccessor.dylib
	cp -v ./kiwix/components/zimXapianIndexer.xpt Kiwix.app/Contents/Resources/components/zimXapianIndexer.xpt
	cp -v ./kiwix/components/zimXapianIndexer.dylib Kiwix.app/Contents/Resources/components/zimXapianIndexer.dylib
	cp -v ./kiwix/components/contentManager.xpt Kiwix.app/Contents/Resources/components/contentManager.xpt
	cp -v ./kiwix/components/contentManager.dylib Kiwix.app/Contents/Resources/components/contentManager.dylib
	cp -v ./kiwix/components/cluceneAccessor.xpt Kiwix.app/Contents/Resources/components/cluceneAccessor.xpt
	cp -v ./kiwix/components/cluceneAccessor.dylib Kiwix.app/Contents/Resources/components/cluceneAccessor.dylib
	cp -v ./kiwix/components/zimCluceneIndexer.xpt Kiwix.app/Contents/Resources/components/zimCluceneIndexer.xpt
	cp -v ./kiwix/components/zimCluceneIndexer.dylib Kiwix.app/Contents/Resources/components/zimCluceneIndexer.dylib
	cp -v src/components/components.list Kiwix.app/Contents/Resources/components/components.list
	rsync -rl /Library/Frameworks/XUL.framework/ Kiwix.app/Contents/Frameworks/XUL.framework/
	cp -v /Library/Frameworks/XUL.framework/Versions/Current/xulrunner Kiwix.app/Contents/MacOS/xulrunner

	mv Kiwix.app/Contents/Resources/chrome/content/main/js/logger_rlz.js Kiwix.app/Contents/Resources/chrome/content/main/js/logger.js

	cp -Lv $(STATIC_LIBS) Kiwix.app/Contents/Frameworks/

	find Kiwix.app/Contents/Frameworks/ -name '*.dylib' -exec install_name_tool -change /usr/local/lib/libz.1.dylib @executable_path/../Frameworks/libz.dylib {} \;

	find Kiwix.app/Contents/Resources/components -name '*.dylib' -exec install_name_tool -change /usr/local/lib/liblzma.1.dylib @executable_path/../Frameworks/liblzma.dylib {} \;

	find Kiwix.app/Contents/Frameworks/ -name '*.dylib' -exec install_name_tool -change libicuuc.44.dylib @executable_path/../Frameworks/libicuuc.dylib {} \;
	find Kiwix.app/Contents/Resources/components -name '*.dylib' -exec install_name_tool -change libicuuc.44.dylib @executable_path/../Frameworks/libicuuc.dylib  {} \;
	
	find Kiwix.app/Contents/Frameworks/ -name '*.dylib' -exec install_name_tool -change libicudata.44.dylib @executable_path/../Frameworks/libicudata.dylib {} \;
	find Kiwix.app/Contents/Frameworks/ -name '*.dylib' -exec install_name_tool -change ../lib/libicudata.44.2.dylib @executable_path/../Frameworks/libicudata.dylib {} \;
	find Kiwix.app/Contents/Frameworks/ -name '*.dylib' -exec install_name_tool -change ../lib/libicudata.44.dylib @executable_path/../Frameworks/libicudata.dylib {} \;
	find Kiwix.app/Contents/Resources/components -name '*.dylib' -exec install_name_tool -change ../lib/libicudata.44.2.dylib @executable_path/../Frameworks/libicudata.dylib  {} \;
	
	find Kiwix.app/Contents/Resources/components -name '*.dylib' -exec install_name_tool -change libicui18n.44.dylib @executable_path/../Frameworks/libicui18n.dylib {} \;

	find Kiwix.app/Contents/Resources/components -name '*.dylib' -exec install_name_tool -change /usr/local/lib/libxapian.22.dylib @executable_path/../Frameworks/libxapian.dylib {} \;

	find Kiwix.app/Contents/Resources/components -name '*.dylib' -exec install_name_tool -change /usr/local/lib/libclucene.0.dylib @executable_path/../Frameworks/libclucene.dylib  {} \;

	strip `find Kiwix.app/Contents/Resources -executable -type f | grep -v ".sh" | grep -v ".py" | grep -v sugar` || true

	mkdir -p Kiwix.app/Contents/Resources/bin
	cp -v $(COMPILED_ARIA2_FILES) Kiwix.app/Contents/Resources/bin/
	cp -v $(COMPILED_XAPIAN_COMPACT) Kiwix.app/Contents/Resources/bin/xapian-compact
	chmod +x Kiwix.app/Contents/Resources/bin/*

	rm Kiwix.app/Contents/Resources/*.bat

	cp -v kiwix/chrome/icons/default/main.icns Kiwix.app/Contents/Resources/kiwix.icns
	cp -v kiwix/chrome/icons/default/zim.icns Kiwix.app/Contents/Resources/kiwix-ZIM.icns
	cp -v src/macosx/Info.plist Kiwix.app/Contents/Info.plist

	sed -i -e 's,\.so,\.dylib,g' Kiwix.app/Contents/Resources/chrome.manifest

	cp -v Kiwix.app/Contents/Frameworks/XUL.framework/Versions/Current/libmozglue.dylib Kiwix.app/Contents/MacOS/libmozglue.dylib
	
	chmod -R 755 Kiwix.app

	bunzip2 -kf src/macosx/kiwix_template.dmg.bz2
	$(MKDIR_P) kiwix_dmg
	hdiutil attach src/macosx/kiwix_template.dmg -noautoopen -quiet -mountpoint ./kiwix_dmg
	rm -rf ./kiwix_dmg/Kiwix.app
	mv Kiwix.app kiwix_dmg/
	hdiutil detach ./kiwix_dmg -quiet -force
	rm -f $(PACKAGE)-$(VERSION)-$(ARCH).dmg
	hdiutil convert src/macosx/kiwix_template.dmg -quiet -format UDZO -imagekey zlib-level=9 -o $(PACKAGE)-$(VERSION)-$(ARCH).dmg
	rm -f src/macosx/kiwix_template.dmg

universal: $(PACKAGE)-$(VERSION)-i386.dmg $(PACKAGE)-$(VERSION)-x86_64.dmg
	rm -rf universal_tmp
	mkdir -p universal_tmp/{i386,x86_64,ub}

	hdiutil attach $(PACKAGE)-$(VERSION)-i386.dmg -noautoopen -quiet -mountpoint universal_tmp/i386
	hdiutil attach $(PACKAGE)-$(VERSION)-x86_64.dmg -noautoopen -quiet -mountpoint universal_tmp/x86_64

	bunzip2 -kf src/macosx/kiwix_template.dmg.bz2
	hdiutil attach src/macosx/kiwix_template.dmg -noautoopen -quiet -mountpoint universal_tmp/ub
	rm -rf universal_tmp/ub/Kiwix.app
	rsync -rl universal_tmp/x86_64/Kiwix.app universal_tmp/ub/

	lipo -create -output universal_tmp/ub/Kiwix.app/Contents/Resources/components/zimAccessor.dylib -arch i386 universal_tmp/i386/Kiwix.app/Contents/Resources/components/zimAccessor.dylib -arch x86_64 universal_tmp/x86_64/Kiwix.app/Contents/Resources/components/zimAccessor.dylib

	lipo -create -output universal_tmp/ub/Kiwix.app/Contents/Resources/components/contentManager.dylib -arch i386 universal_tmp/i386/Kiwix.app/Contents/Resources/components/contentManager.dylib -arch x86_64 universal_tmp/x86_64/Kiwix.app/Contents/Resources/components/contentManager.dylib

	lipo -create -output universal_tmp/ub/Kiwix.app/Contents/Resources/components/xapianAccessor.dylib -arch i386 universal_tmp/i386/Kiwix.app/Contents/Resources/components/xapianAccessor.dylib -arch x86_64 universal_tmp/x86_64/Kiwix.app/Contents/Resources/components/xapianAccessor.dylib

	lipo -create -output universal_tmp/ub/Kiwix.app/Contents/Resources/components/zimXapianIndexer.dylib -arch i386 universal_tmp/i386/Kiwix.app/Contents/Resources/components/zimXapianIndexer.dylib -arch x86_64 universal_tmp/x86_64/Kiwix.app/Contents/Resources/components/zimXapianIndexer.dylib

	lipo -create -output universal_tmp/ub/Kiwix.app/Contents/Resources/components/cluceneAccessor.dylib -arch i386 universal_tmp/i386/Kiwix.app/Contents/Resources/components/cluceneAccessor.dylib -arch x86_64 universal_tmp/x86_64/Kiwix.app/Contents/Resources/components/cluceneAccessor.dylib

	lipo -create -output universal_tmp/ub/Kiwix.app/Contents/Resources/components/zimCluceneIndexer.dylib -arch i386 universal_tmp/i386/Kiwix.app/Contents/Resources/components/zimCluceneIndexer.dylib -arch x86_64 universal_tmp/x86_64/Kiwix.app/Contents/Resources/components/zimCluceneIndexer.dylib


	hdiutil detach universal_tmp/i386 -quiet -force
	hdiutil detach universal_tmp/x86_64 -quiet -force	

	hdiutil detach universal_tmp/ub -quiet -force
	rm -f $(PACKAGE)-$(VERSION)-universal.dmg
	hdiutil convert src/macosx/kiwix_template.dmg -quiet -format UDZO -imagekey zlib-level=9 -o $(PACKAGE)-$(VERSION)-universal.dmg
	rm -f src/macosx/kiwix_template.dmg

# Windows rule
win:
	cd src/dependencies ; make win
	cd src/zimlib/src ; if [ ! -f zim.lib ] ; then make -f Makefile.mvsc ; fi
	cd src/ctpp2/src ; if [ ! -f ctpp2.lib ] ; then make -f Makefile.mvsc ; fi
	cd src/pugixml ; if [ ! -f pugixml.lib ] ; then make -f Makefile.mvsc ; fi
	cd src/components/xapianAccessor ; if [ ! -f xapianAccessor.dll ] ; then make -f Makefile.mvsc ; fi
	cd src/components/zimAccessor ; if [ ! -f zimAccessor.dll ] ; then make -f Makefile.mvsc ; fi
	cd src/components/zimXapianIndexer ; if [ ! -f zimXapianIndexer.dll ] ; then make -f Makefile.mvsc ; fi
	cd src/components/contentManager ; if [ ! -f contentManager.dll ] ; then make -f Makefile.mvsc ; fi
	cp src/components/xapianAccessor/xapianAccessor.dll kiwix/components/
	cp src/components/xapianAccessor/IXapianAccessor.xpt kiwix/components/xapianAccessor.xpt
	cp src/components/zimAccessor/zimAccessor.dll kiwix/components/
	cp src/components/zimAccessor/IZimAccessor.xpt kiwix/components/zimAccessor.xpt
	cp src/components/zimXapianIndexer/zimXapianIndexer.dll kiwix/components/
	cp src/components/zimXapianIndexer/IZimXapianIndexer.xpt kiwix/components/zimXapianIndexer.xpt
	cp src/components/contentManager/contentManager.dll kiwix/components/
	cp src/components/contentManager/IContentManager.xpt kiwix/components/contentManager.xpt
	cp -r src/dependencies/xulrunner ./kiwix
	cp /c/Program\ Files/Microsoft\ Visual\ Studio\ 9.0/VC/redist/x86/Microsoft.VC90.CRT/* kiwix/xulrunner/
	cp -r src/dependencies/xz/windows/liblzma.dll ./kiwix/xulrunner
	cp src/dependencies/icu/bin/icudt*.dll ./kiwix/xulrunner
	cp src/dependencies/icu/bin/icuin*.dll ./kiwix/xulrunner
	cp src/dependencies/icu/bin/icuuc*.dll ./kiwix/xulrunner
	cp static/results.tmpl kiwix/chrome/static/results.tmpl
	rm -rf kiwix/xulrunner/dictionaries
	rm -rf kiwix/xulrunner/xulrunner-stub.exe
	rm -rf kiwix/xulrunner/README
	cd src/indexer ; if [ ! -f kiwix-index.exe ] ; then make -f Makefile.mvsc ; fi	
	cd src/manager ; if [ ! -f kiwix-manage.exe ] ; then make -f Makefile.mvsc ; fi	
	cd src/installer ; if [ ! -f kiwix-install.exe ] ; then make -f Makefile.mvsc ; fi	
	cp src/indexer/kiwix-index.exe ./kiwix/xulrunner
	cp src/manager/kiwix-manage.exe ./kiwix/xulrunner
	cp src/installer/kiwix-install.exe ./kiwix/xulrunner

windist: 
	rm -rf dvd/install dvd/kiwix
	svn update dvd/install
	svn update dvd/kiwix
	cp -rf kiwix dvd/
